#!/bin/sh
# whereami - find current country code

WHEREAMI_CACHE=${WHEREAMI_CACHE:-${XDG_CACHE_HOME:-$HOME/.cache}/$(basename "$0")}

HELP=$(cat <<EOF
whereami - find current country code
Usage: whereami [-cdh]
  -c N      use cached value if no older than N days
  -f CC     force country code (e.g. when offline)
  -h        show this message and exit

Cache is written to \$WHEREAMI_CACHE=$WHEREAMI_CACHE and has format
'TIMESTAMP COUNTRY'.
EOF
)

CACHE_EXPIRY=
CC=
while getopts :c:f:h OPT; do
	case "$OPT" in
	c)	case "$OPTARG" in
			''|*[!0-9]*) echo >&2 "error: -c must be number" ; exit 1 ;;
			*) CACHE_EXPIRY=$OPTARG ;;
		esac
		;;
	f)	case "$OPTARG" in
			[A-Z][A-Z])
				echo "$OPTARG"
				echo "$(date +%s) $OPTARG" > "$WHEREAMI_CACHE"
				exit 0
				;;
			*) echo >&2 "error: -f must be 2 uppercase letters" ; exit 1 ;;
		esac
		;;
	h)	echo "$HELP" ; exit ;;
	*)	echo >&2 "error: unknown option -$OPTARG" ; exit 1 ;;
	esac
done

# read cached value if any
if [ -z "$CC" ] && [ -r "$WHEREAMI_CACHE" ]; then
	read -r TS CC < "$WHEREAMI_CACHE"
	[ -n "$CACHE_EXPIRY" ] \
		&& [ $(( TS + CACHE_EXPIRY*24*3600 )) -lt "$(date +%s)" ] \
		&& CC=
fi

if [ -z "$CC" ]; then
	echo nocache
	command -v curl >/dev/null 2>&1 \
		&& for URL in \
			"https://ipinfo.io/country" \
			"https://ifconfig.io/country_code" \
			"https://api.country.is" ; do

			# TODO: add reasonable --connect-timeout
			R=$(curl -sLf "$URL") || continue
			case "$URL" in
			*api.country.is*)
				R=$(echo "$R" | sed 's/.*"country":"\([^"]*\)".*/\1/') ;;
			esac
			CC=$(echo "$R" | tr '[:lower:]' '[:upper:]')
			echo "$(date +%s) $CC" > "$WHEREAMI_CACHE"
			break
		done
fi

if [ -z "$CC" ]; then
	echo >&2 "error: unable to get country code, use -f if offline"
	exit 1
fi

echo "$CC"

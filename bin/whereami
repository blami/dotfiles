#!/bin/bash
# Geolocate by external IP

# Output: CONTINENT COUNTRY CITY or exit 1 in case of failure
# Takes -c d|w|m argument to cache result for day, week or month to speed up
# query. Without it it will always refresh the cache.
# NOTE: This is mostly for use in my other scripts such as SSH jumps or VPNs
# and its not particularly user or debug friendly. 


command -v curl >/dev/null 2>&1 || exit 1
command -v jq >/dev/null 2>&1 || exit 1

http_request() {
    RESP=$(curl -sL -H "$2" -w "\n%{response_code}" "$1") || return 1
    CODE=$(tail -n1 <<< "$RESP")
    if [ "$CODE" -lt 200 ] || [ "$CODE" -gt 299 ]; then
        return 1
    fi
    sed '$ d' <<< "$RESP"
    return 0
}

CACHE_EXP=
while getopts "c:" OPT; do
    case "$OPT" in
    c)
        case "$OPTARG" in
        d)
            CACHE_EXP=0
            ;;
        w)
            CACHE_EXP=1
            ;;
        m)
            CACHE_EXP=2
            ;;
        *)
            >&2 echo "$(basename "$0"): -c takes only d,w or m"
            exit 1
        esac
        ;;
    \?)
        exit 1 ;;
    esac
done; shift $((OPTIND-1))

# Cache
# NOTE: Can't rely on mtime as some systems don't update it
# CUR_DATE is array in format: "DoY WoY MoY"
IFS=" " read -ra CUR_DATE <<<"$(date +'%j %U %m')"
CACHE=${XDG_CACHE_DIR:-~/.local/cache}/whereami
[ ! -d "$(dirname "$CACHE")" ] && mkdir -p "$(dirname "$CACHE")"
if [ -r "$CACHE" ] && [ -n "$CACHE_EXP" ] ; then
    OUT=$(head -1 "$CACHE")
    IFS=" " read -ra CACHE_DATE <<<"$(tail -1 "$CACHE")"
    if [ "${CUR_DATE[$CACHE_EXP]}" -eq "${CACHE_DATE[$CACHE_EXP]}" ]; then
        echo "$OUT"
        exit 0
    fi
fi

# Get actual GEO information
IP=$(http_request "https://ifconfig.me") || exit 1
GEO=$(http_request "https://tools.keycdn.com/geo.json?host=$IP" "User-Agent: keycdn-tools:https://$IP") || exit 1

OUT=$(jq -r ".data.geo | [.continent_code,.country_code,.city] | join(\" \")" <<< "$GEO") || exit 1
[ -z "$OUT" ] && exit 1

# Write to cache and output
cat >"$CACHE" <<EOF
$OUT
${CUR_DATE[*]}
EOF
echo "$OUT"

---
# Configure APT and install essential packages

- name: Disabling APT recommendations
  copy:
    src: "{{ role_path }}/files/apt.conf.d/99no-recommends"
    dest: "/etc/apt/apt.conf.d/99no-recommends"
    owner: root
    group: root
    mode: 644
    force: yes

- name: Adding APT GPG keys
  apt_key:
    id: "{{ item.key_id }}"
    keyserver: keyserver.ubuntu.com
    state: present
  loop_control:
    label: "{{ item.name }} {{ item.key_id }}"
  with_items: "{{ apt_repositories }}"

- name: Adding APT repositories
  apt_repository:
    repo: "{{ item.1 }}"
    filename: "{{ item.0.name }}"
  loop_control:
    label: "{{ item.0.name }}.list"
  with_subelements: 
    - "{{ apt_repositories }}"
    - "sources"

- name: Updating APT cache and upgrading/autoremoving packages
  apt:
    update_cache: true
    upgrade: safe
    # Remove un-necessary packages
    autoremove: true

# NOTE Autoremove will remove snap (which we will install later) but will not
# remove /etc/apt/apt.conf.d/20snapd.conf; this fixes it.
- name: Removing APT /etc/apt/apt.conf.d/20snapd.conf
  file:
    path: /etc/apt/apt.conf.d/20snapd.conf
    state: absent
  when:
    - "\"snapd\" not in ansible_facts.packages"

- name: Removing non-essential APT packages
  apt:
    pkg:
      - show-motd
      - update-motd
      - motd-news-config
      - popularity-contest
    state: absent

- name: Installing essential APT packages
  apt:
    pkg: "{{ apt_packages }}"
    state: present

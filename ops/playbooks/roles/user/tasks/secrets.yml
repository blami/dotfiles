---
# Install various secrets (SSH, GPG keys and PEMs) stored in LastPass.

- name: Checking LastPass status
  command: >
    lpass status
  register: lpass
  # Never failed nor changed
  failed_when: false
  changed_when: false

- name: Installing SSH keys from LastPass
  shell:
    chdir: "{{ my_user.home }}"
    cmd: |
      lpass show --sync now "{{ item.name }}" --field="Private Key" > .ssh/keys/{{ item.file }}
      lpass show "{{ item.name }}" --field="Public Key" > .ssh/keys/{{ item.file }}.pub
      chmod 0600 .ssh/keys/{{ item.file }}
  # NOTE DO NOT use 'creates' here to allow ssh key updates
  with_items: "{{ ssh_keys }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - lpass.rc == 0

# TODO This will be a little more complicated
- name: Installing GnuPG keys from LastPass
  debug:
    msg: "~/.gpg"
  when:
    - lpass.rc == 0

- name: Installing IRC certificates from LastPass
  shell:
    chdir: "{{ my_user.home }}"
    cmd: |
      lpass show --sync now "{{ item.name }}" --notes > .config/weechat/certs/{{ item.file }}
      chmod 0600 .config/weechat/certs/{{ item.file }}
  with_items: "{{ irc_certs }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - lpass.rc == 0

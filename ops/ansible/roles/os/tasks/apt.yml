---
# Configure APT and install/remove basic packages

- name: Disabling APT Recommendations
  copy:
    src: "{{ role_path }}/files/apt.conf.d/99no-recommends"
    dest: "/etc/apt/apt.conf.d/99no-recommends"
    owner: root
    group: root
    mode: 644
    force: true

# TODO: Setup old kernel/firmware package autoremoval

- name: Removing .distUpgrade Files
  find:
    patterns: "*.distUpgrade"
    paths: /etc/apt
    recurse: true
  register: out
- file:
    path: "{{ item.path }}"
    state: absent
  loop_control:
    label: "{{ item.path }}"
  with_items: "{{ out.files | default([]) }}"

- include_role:
    name: common
    tasks_from: apt_repositories

# NOTE: If Ansible is installed from Ubuntu repositories then attempt to
# upgrade to PPA version will clash on PPA's ansible-core. In case of upgrade 

# If ansible is installed from Ubuntu repositories it will clash with upstream
# ansible-core package.
- name: Upgrading Ansible
  shell:
    cmd: |
      /usr/bin/apt-get remove --purge --yes ansible
      /usr/bin/apt-get install --yes ansible  
    # NOTE: This needs to be done as shell command in one step so that Ansible is
    # installed for continuing with the next task.
    warn: false
  register: out
  when:
    - "\"packages\" in ansible_facts"
    - "\"ansible\" in ansible_facts.packages" 
    - "ansible_facts.packages.ansible[0].origin == \"Ubuntu\""
# NOTE: In case upgrade is performed it is necessary to terminate to avoid
# Python module mixing.
- fail:
    msg: "Ansible was upgraded. Restart playbook to continue."
  when:
    - out.changed

- name: Upgrading APT Packages
  apt:
    upgrade: "safe"
    autoremove: true

- include_role:
    name: common
    tasks_from: apt_packages
